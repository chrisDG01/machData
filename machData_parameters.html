<!DOCTYPE html>
<html>
<head>
	<title> manage run parameters and domain data..</title>
	 <script  src="globalSessionVars.js"></script>
</head>	
<script>

  
  function doInitiateVars() {

	distributeGlobalVars()
	
  } // doInitiateVars
 
 
 function updateParams() {
 
 
 	g_parameters.use_max_DB_ID		  	= document.getElementById('txt_useMaxDbId').value 		

	g_parameters.global_id_batch_size	= document.getElementById('txt_globalIdBatchSize').value
	g_parameters.global_id            	= document.getElementById('txt_globalId').value  		
	g_parameters.num_of_batches	 		= document.getElementById('txt_numOfBatches').value  	
	g_parameters.curr_batch_number      = document.getElementById('txt_currBatchNumber').value  
	g_parameters.delim_char           	= document.getElementById('txt_delimChar').value  		
	g_parameters.truncate_and_load 		= document.getElementById('txt_truncateAndLoad').value  
	g_parameters.write_to_DB 		 	= document.getElementById('txt_writeToDb').value  		
  
 } // updateParams
 
 
 function loadInputValues() {

	document.getElementById('txt_useMaxDbId').value 		=	g_parameters.use_max_DB_ID		  	  
	document.getElementById('txt_globalIdBatchSize').value 	=	g_parameters.global_id_batch_size	 
	document.getElementById('txt_globalId').value  		 	=	g_parameters.global_id            	  
	document.getElementById('txt_numOfBatches').value  	 	=	g_parameters.num_of_batches	 		 
	document.getElementById('txt_currBatchNumber').value   	=	g_parameters.curr_batch_number       
	document.getElementById('txt_delimChar').value  		=	g_parameters.delim_char           	  
	document.getElementById('txt_truncateAndLoad').value   	=	g_parameters.truncate_and_load 		 
	document.getElementById('txt_writeToDb').value  		=	g_parameters.write_to_DB 		 	 
  
  } // loadInputValues
  

function showRows(tblName) {

  var tblData  = g_domainData[tblName]
  var shw      = "<table id='tbl_rows'>"
  var edt      = "<table id='tbl_edit'><tr>"
  shw = shw + "<tr colspan=2><td>" + tblName + "</td></tr>"
  
  shw = shw + '<tr>'
  for (i=0; i< g_tableList[tblName].length; i++) {
	shw = shw + '<td>' + g_tableList[tblName][i][0] + '</td>'
  } 
  shw = shw + '</tr>'
  	
	
  if (tblName    in g_domainData == true) {

	var nrows    = tblData.length
	var ncols    = tblData[0].length
	var rcnt     = 0  
	for (r = 0; r < nrows; r++) { 
	    shw = shw + "<tr  id='selectedRow_" +r.toString()+"'  style='background:white' onclick=doEdit(this,'EDIT')>"
		
		for (c = 0; c < ncols; c++) {
			shw = shw + '<td>' + tblData[r][c] + '</td>' 
			
		} // for c	
	    shw = shw + '</tr>'
		edt = edt + '</tr>'
		rcnt ++
		
	} // for r
  } // if
  
  shw = shw + '</table>'
  
  for (var c=0; c< g_tableList[tblName].length; c++) {
	edt = edt + "<td><input type='text' id='txt_col_"+c+"' value=''></td>"
	} // for
  edt = edt + '</tr>'
	 
	 
  edt = edt + '</table>'
  
  edt = edt + "<table><tr>"
  edt = edt + "<td><input type='button' id='btn_delRow' value='Delete Row' onclick=delRow()></td>"
  edt = edt + "<td><input type='button' id='btn_addRow' value='Save Row' onclick=saveRow()></td>"
  edt = edt + "<td><input type='button' id='btn_delRow' value='Delete Row' onclick=delRow()></td>"
  edt = edt + "<td><input type='button' id='btn_clearTable' value='Clear Selections' onclick=doEdit('','CLEAR_SELECT')></td>"
  edt = edt + "<td><input type='button' id='btn_SaveTable' value='Save Table' onclick=doSaveTable('" + tblName + "')></td>"
  edt = edt + "</tr></table>"
 
  document.getElementById('div_rows').innerHTML = shw;
  document.getElementById('div_edit').innerHTML = edt;

   
} // showRows
  
 
function doEdit(row, cmd) {   
	
	var rowTable = document.getElementById('tbl_rows')
	
	if ( cmd == 'EDIT' ) { 
		var ncols = rowTable.rows[1].cells.length
		var txt_editID = ''
		var c = 0
		
		 if (g_editControl.editRow != '') { 
			rowTable.rows[g_editControl.editRow.rowIndex].style.background = 'white'; 
		}
		rowTable.rows[row.rowIndex].style.background = 'lightgrey';
		g_editControl.editRow = row
		
		for (c=0; c < ncols; c++) {
			txt_editID = 'txt_col_' + c.toString()
			document.getElementById(txt_editID).value = rowTable.rows[row.rowIndex].cells[c].innerHTML
		} // for
	}
	
	if ( cmd == 'CLEAR_SELECT') 
	{		
	    for (var c=0; c < rowTable.rows[1].cells.length; c++) {    // edit table has same number of rows as the rows table .. use row table cell count here
			document.getElementById('txt_col_'+c.toString()).value = '';
		} // for
		if (g_editControl.editRow != '' && (g_editControl.editRow.rowIndex >= 0 &&  g_editControl.editRow.rowIndex < rowTable.rows.length)) { 
			rowTable.rows[g_editControl.editRow.rowIndex].style.background = 'white'; 
		}
		g_editControl.editRow = ''
	}	
  } // doEdit
  

  
function saveRow() {

  var rowTable = document.getElementById('tbl_rows')
  var rowNum   = rowTable.rows.length  
  var edtIDs   = document.querySelectorAll('[id]');
  var idsArr   = Array.from(edtIDs);
  var rowData  = new Array(rowTable.rows[0].cells.length - 1)
  var idName   = ''
  var colNum   = 0
  
  for (i=0; i<idsArr.length; i++) { 
	idName = idsArr[i].id
	if ( idName.startsWith('txt_col_') ) { 
		colNum = parseInt(idName.slice(idName.lastIndexOf('_') + 1))
		rowData[colNum] = document.getElementById(idsArr[i].id).value;
	} // if  
  }	

  if (g_editControl.editRow == '') { 
    var newRow     	= rowTable.insertRow(-1);
    newRow.onclick 	= (function() {doEdit(this, 'EDIT')});
	newRow.id       = 'selectedRow_' + rowTable.rows.length.toString()
	newRow.style.background = 'white';
	

  }
  else
  {
    var newRow = document.getElementById(g_editControl.editRow.id)
  }
      
  for (i=0; i<rowData.length; i++) {
    if 	( g_editControl.editRow == '' ) { newRow.insertCell(i); }
	newRow.cells[i].innerHTML = rowData[i]
  }
  
  //if (g_editControl.editRow != '') { 
//			rowTable.rows[g_editControl.editRow.rowIndex].style.background = 'white'; 
//		}
  doEdit(null,'CLEAR_SELECT')
} // saveRow
  
  
  
  function delRow(){
    
	var rowTable 	= document.getElementById('tbl_rows')
	var rID      	= document.getElementById(g_editControl.editRow.id)
	
   	rowTable.deleteRow(rID.rowIndex); 
	doEdit(null,'CLEAR_SELECT')
	

  } // delRow
  
  
  function doTableToJSON(tblID) {
	var jsonTbl   = {}
    var tbl       = document.getElementById(tblID);
	var rowA      = []
	var tableName = document.getElementById('tbl_rows').rows[0].cells[0].innerHTML
    	
	jsonTbl[tableName] = []

	// start at row 2 because 0 = domain table name ; 1 = column names
    //	
	for (r = 2; r < tbl.rows.length; r++) {    
	    rowA = [];
		for ( c = 0; c < tbl.rows[r].cells.length; c++) {
	      rowA[c] = tbl.rows[r].cells[c].innerHTML
		}
			
	   jsonTbl[tableName][r-2] = rowA;
	} // for r 
	return jsonTbl

	} // doTableToJSON
  
  
  
  function showTables() {
	var dtbls = [];
	var shw = "<table id='tbl_tables'><tr>";
	
	for (var t in g_tableList) {
	   if (g_tableList[t].toString().includes('PDK')) {dtbls.push(t)}
	} // for

		
	for ( i = 0; i < dtbls.length; i++) {
		shw = shw + "<td onclick=showRows('" + dtbls[i] + "')>" + dtbls[i] + "</td>"
	}
	shw = shw + "</tr>"
	shw = shw + '</table>'
	
	document.getElementById('div_tables').innerHTML = shw ;
 
  } // showTables
     
  
  
  function doSaveTable(tblName) {
    
   var jsTbl = doTableToJSON('tbl_rows');
   Object.assign(g_domainData,jsTbl);
   
   showRows(tblName);

  } // doSaveTable

  
  
  
function doDesign() {
	updateParams()
    putGlobalVars();
	window.location.href = "machData_designER.html";
  
  } // doRelations
  
 
function doRelations() {
	updateParams()
    putGlobalVars();
	window.location.href = "machData_relations.html";
  
  } // doRelations
  
  
 function doOnLoad() {
  
   distributeGlobalVars()
   loadInputValues()
   g_editControl.editRow = ''
   showTables()
   
 }  // doOnLoad
   

 
 function doDebug() {

  alert(JSON.stringify(g_tableList));
  alert(Object.keys(g_tableList));
  
 } // doDebug

  
  
</script>
<style>

   	div.parameters {
   		width:  400px;
		height: 380px;
		margin: auto;
		border: 3px solid #73AD21;
		position: absolute; left: 50px; top: 100px; 
	}
	div.menu {
   		width: 800px;
		height: 50px;
		margin: auto;
		border: 3px solid #73AD21;
		position: absolute; left: 0px; top: 400px; 
	}
	div.tables {
   		width:  380px;
		height: 50px;
		margin: auto;
		border: 3px solid black;
		position: absolute; left: 420px; top: 0px; 
	}	
	div.rows {
   		width:  380px;
		height: 280px;
		margin: auto;
		border: 3px solid blue;
		position: absolute; left: 420px; top: 50px; 
	}			
	div.edit {
   		width:  380px;
		height: 50px;
		margin: auto;
		border: 3px solid green;
		position: absolute; left: 420px; top: 330px; 
	}
	table.parameters {
		border: 1px solid red;
		width: 100%;
		padding: 1px;
		position: absolute; left: 0px; top: 0px; 
	}	
	
	button.list {
		width:  100px;
		height: 30px;
		border: 3px solid #ccD000;
	}
	
	
		
</style>

<body onload='doOnLoad()'>

<h1>manage mach data run parameters and domain data:</h1>
<br>

<div id='div_parameters' class='parameters'>
<table id='tbl_parameters' class='parameters'>
	<tr>
		<td>use_max_DB_ID</td><td>			<input type='text' id='txt_useMaxDbId'  		value='false' ></td></td>
	</tr>	                                                                                
	<tr>                                                                                    
		<td>global_id_batch_size</td><td>	<input type='text' id='txt_globalIdBatchSize'	value='10' ></td></td>
	</tr>                                                                                   
	<tr>	                                                                                
		<td>global_id</td><td>				<input type='text' id='txt_globalId'  			value='1' ></td></td>
	</tr>                                                                                   
	<tr>                                                                                    
		<td>num_of_batches</td><td>			<input type='text' id='txt_numOfBatches'  		value='1' ></td></td>
	</tr>		                                                                            
	<tr>	                                                                                
		<td>curr_batch_number</td><td>		<input type='text' id='txt_currBatchNumber'  	value='0' ></td></td>
	</tr>                                                                                   
	<tr>	                                                                                
		<td>delim_char</td><td>				<input type='text' id='txt_delimChar'  			value='|' ></td></td>
	</tr>                                                                                   
	<tr>	                                                                                
		<td>truncate_and_load</td><td>		<input type='text' id='txt_truncateAndLoad'  	value='false' ></td></td>
	</tr>                                                                                   
	<tr>	                                                                                
		<td>write_to_DB</td><td>			<input type='text' id='txt_writeToDb'  			value='false' ></td></td>
	</tr>		
</div>

<div id='div_tables' class='tables' >
</div>

<div id='div_rows' class='rows' >
</div>


<div id='div_edit' class='edit' >
</div>


<div id='div_menu' class='menu' >

  <button id='btn_design' class='list' onclick="doDesign()">goto design</button>
  <button id='btn_parms' class='list' onclick="doRelations()">goto relations</button>

</div>  

</body>
</html>
