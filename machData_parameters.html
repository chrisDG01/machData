<!DOCTYPE html>
<html>
<head>
	<title> build relation..</title>
	 <script  src="globalSessionVars.js"></script>
</head>	
<script>




  function doDownloadFile(name) {
  var jsonStr = JSON.stringify(doTableToJSON('tbl_desc'))
	
	const a = document.createElement('a');
	const type = name.split(".").pop();
	a.href = URL.createObjectURL( new Blob([jsonStr], { type:`text/${type === "txt" ? "plain" : type}` }) );
	a.download = name;
	a.click();
	//document.getElementById('div_keys').innerHTML = jsonMDTxt + '....' + jsonData;
  } // doDownloadFile
  
  function readSingleFile(evt) {
    //Retrieve the first (and only!) File from the FileList object
    var f = evt.target.files[0]; 
  
    if (f) {
      var r = new FileReader();
      r.onload = function(e) { 
	      var contents = e.target.result;
		  document.getElementById('div_keys').innerHTML = contents;
		  jsonData = contents;

      }
      r.readAsText(f);
    } else { 
      alert("Failed to load file");
    }
  } // readSingleFile
  
  
  // ================================================================================================= //
  
  
  function doInitiateVars() {

	distributeGlobalVars()
	
  } // doInitiateVars
 
 
 function updateParams() {
 
 
 	g_parameters.use_max_DB_ID		  	= document.getElementById('txt_useMaxDbId').value 		

	g_parameters.global_id_batch_size	= document.getElementById('txt_globalIdBatchSize').value
	g_parameters.global_id            	= document.getElementById('txt_globalId').value  		
	g_parameters.num_of_batches	 		= document.getElementById('txt_numOfBatches').value  	
	g_parameters.curr_batch_number      = document.getElementById('txt_currBatchNumber').value  
	g_parameters.delim_char           	= document.getElementById('txt_delimChar').value  		
	g_parameters.truncate_and_load 		= document.getElementById('txt_truncateAndLoad').value  
	g_parameters.write_to_DB 		 	= document.getElementById('txt_writeToDb').value  		
 
 
 } // updateParams
 
 function loadInputValues() {

	document.getElementById('txt_useMaxDbId').value 		=	g_parameters.use_max_DB_ID		  	  
	document.getElementById('txt_globalIdBatchSize').value 	=	g_parameters.global_id_batch_size	 
	document.getElementById('txt_globalId').value  		 	=	g_parameters.global_id            	  
	document.getElementById('txt_numOfBatches').value  	 	=	g_parameters.num_of_batches	 		 
	document.getElementById('txt_currBatchNumber').value   	=	g_parameters.curr_batch_number       
	document.getElementById('txt_delimChar').value  		=	g_parameters.delim_char           	  
	document.getElementById('txt_truncateAndLoad').value   	=	g_parameters.truncate_and_load 		 
	document.getElementById('txt_writeToDb').value  		=	g_parameters.write_to_DB 		 	 
  
  } // loadInputValues
  
function showRows(tblName) {

  var tblData  = g_domainData[tblName]
  var shw      = "<table id='tbl_rows'>"
  var edt      = "<table id='tbl_edit'>"
  shw = shw + "<tr colspan=2><td>" + tblName + "</td></tr>"
	
	
  if (tblData) {
	var nrows    = tblData.length
	var ncols    = tblData[0].length
	  
	for (r = 0; r < nrows; r++) { 
	    shw = shw + '<tr>'
		for (c = 0; c < ncols; c++) {
			shw = shw + '<td>' + tblData[r][c] + '</td>' 
			edt = edt + "<td><input type='text' id='txt_edit_"+c+"' value='ddd'></td>"
		} // for c	
	    shw = shw + '</tr>'
		edt = edt + '</tr>'
		
	} // for r
  } // if
  else
  {
     shw = shw + '<tr>'
	 edt = edt + '<tr>'
     for (var r=0; r<  g_tableList[tblName].length; r++) {
			shw = shw + '<td>' + g_tableList[tblName][r][0] + '</td>'
			edt = edt + "<td><input type='text' id='txt_edit_"+r+"' value='ddd'></td>"
			
			} // for
	 shw = shw + '</tr>'
	 edt = edt + '</tr>'
  
  } // else 
  

  shw = shw + '</table>'
  edt = edt + '</table>'
  
  edt = edt + "<table><tr><td><input type='button' id='btn_addRow' value='Add Row' onclick='saveRow()'></td>"
  edt = edt + "<td><input type='button' id='btn_SaveTable' value='Save Table' onclick='doSaveTable()'></td></tr>"
  edt = edt + '</table>'
  
  document.getElementById('div_rows').innerHTML = shw;
  document.getElementById('div_edit').innerHTML = edt;
   

} // showRows
  

function saveRow(tblName) {

  var rowTable = document.getElementById('tbl_rows')
  var rowNum   = rowTable.rows.length  
  var edtIDs   = document.querySelectorAll('[id]');
  var idsArr   = Array.from(edtIDs);
  var rowData  = new Array(rowTable.rows[0].cells.length - 1)
  var idName   = ''
  var colNum   = 0
  
  
  for (i=0; i<idsArr.length; i++) { 
	idName = idsArr[i].id
	if ( idName.startsWith('txt_edit_') ) { 
		colNum = parseInt(idName.slice(idName.lastIndexOf('_') + 1))
		rowData[colNum] = document.getElementById(idsArr[i].id).value;
	} // if  
  }	
 //console.log(rowData)
 var newRow     = rowTable.insertRow(-1);
 newRow.id = 'edtRow_' + rowNum
 newRow.ondblclick = (function() {delRow(this)});
 for (i=0; i<rowData.length; i++) {
	newRow.insertCell(i).innerHTML = rowData[i]
  }
 
 
} // saveRow
  
  function delRow(row){
  
	var rowTable = document.getElementById('tbl_rows')
	var rID      = document.getElementById(row.id)
	//console.log(rn.rowIndex)	
	rowTable.deleteRow(rID.rowIndex); 
  
  } // delRow
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  function doTableToJSON(tblID) {
	var jsonTbl   = {}
    var tbl       = document.getElementById(tblID);
	var rowA      = []
	var dispr;
	
	jsonTbl[tableName] = []

	for (r = 1; r < tbl.rows.length; r++) {
	    rowA = [];
		dr = r - 1
		for ( c = 0; c < tbl.rows[r].cells.length; c++) {
				if (c == 0) 
				   { 
				      rowA[c] = document.getElementById('tbl_desc_colName_'+r).value
				    }
				else
				   { 
				      rowA[c] = tbl.rows[r].cells[c].innerHTML
				   }
			}
			
	   jsonTbl[tableName][dr] = rowA;
	} // for r 
	return jsonTbl

	} // doTableToJSON
  
  
  
  function showTables() {
	var dtbls = [];
	var shw = "<table id='tbl_tables'><tr>";
	
	for (var t in g_tableList) {
	   if (g_tableList[t].toString().includes('PDK')) {dtbls.push(t)}
	} // for

		
	for ( i = 0; i < dtbls.length; i++) {
		shw = shw + "<td onclick=showRows('" + dtbls[i] + "')>" + dtbls[i] + "</td>"
	}
	shw = shw + "</tr>"
	shw = shw + '</table>'
	
	document.getElementById('div_tables').innerHTML = shw ;
 
  } // showTables
     
  
  
  function doSaveTable() {
    
   var jsTbl = doTableToJSON('tbl_rows');
	
   Object.assign(g_domainData,jsTbl);
   
   doShowRows();

  } // doSaveTable

  
  
  
function doDesign() {
	updateParams()
    putGlobalVars();
	window.location.href = "machData_designER.html";
  
  } // doRelations
  
 
function doRelations() {
	updateParams()
    putGlobalVars();
	window.location.href = "machData_relations.html";
  
  } // doRelations
  
  
 function doOnLoad() {
  
   distributeGlobalVars()
   loadInputValues()
   showTables()
   
 }  // doOnLoad
   

 
 function doDebug() {

  alert(JSON.stringify(g_tableList));
  alert(Object.keys(g_tableList));
  
 } // doDebug

  
  
</script>
<style>

   	div.parameters {
   		width:  400px;
		height: 380px;
		margin: auto;
		border: 3px solid #73AD21;
		position: absolute; left: 50px; top: 100px; 
	}
	div.menu {
   		width: 800px;
		height: 50px;
		margin: auto;
		border: 3px solid #73AD21;
		position: absolute; left: 0px; top: 400px; 
	}
	div.tables {
   		width:  380px;
		height: 50px;
		margin: auto;
		border: 3px solid black;
		position: absolute; left: 420px; top: 0px; 
	}	
	div.rows {
   		width:  380px;
		height: 280px;
		margin: auto;
		border: 3px solid blue;
		position: absolute; left: 420px; top: 50px; 
	}			
	div.edit {
   		width:  380px;
		height: 50px;
		margin: auto;
		border: 3px solid green;
		position: absolute; left: 420px; top: 330px; 
	}
	table.parameters {
		border: 1px solid red;
		width: 100%;
		padding: 1px;
		position: absolute; left: 0px; top: 0px; 
	}	
	
	button.list {
		width:  100px;
		height: 30px;
		border: 3px solid #ccD000;
	}
	
	
		
</style>

<body onload='doOnLoad()'>

<h1>create mach data relations (ver 2.0):</h1>
<br>

<div id='div_parameters' class='parameters'>
<table id='tbl_parameters' class='parameters'>
	<tr>
		<td>use_max_DB_ID</td><td>			<input type='text' id='txt_useMaxDbId'  		value='false' ></td></td>
	</tr>	                                                                                
	<tr>                                                                                    
		<td>global_id_batch_size</td><td>	<input type='text' id='txt_globalIdBatchSize'	value='10' ></td></td>
	</tr>                                                                                   
	<tr>	                                                                                
		<td>global_id</td><td>				<input type='text' id='txt_globalId'  			value='1' ></td></td>
	</tr>                                                                                   
	<tr>                                                                                    
		<td>num_of_batches</td><td>			<input type='text' id='txt_numOfBatches'  		value='1' ></td></td>
	</tr>		                                                                            
	<tr>	                                                                                
		<td>curr_batch_number</td><td>		<input type='text' id='txt_currBatchNumber'  	value='0' ></td></td>
	</tr>                                                                                   
	<tr>	                                                                                
		<td>delim_char</td><td>				<input type='text' id='txt_delimChar'  			value='|' ></td></td>
	</tr>                                                                                   
	<tr>	                                                                                
		<td>truncate_and_load</td><td>		<input type='text' id='txt_truncateAndLoad'  	value='false' ></td></td>
	</tr>                                                                                   
	<tr>	                                                                                
		<td>write_to_DB</td><td>			<input type='text' id='txt_writeToDb'  			value='false' ></td></td>
	</tr>		
</div>

<div id='div_tables' class='tables' >
</div>

<div id='div_rows' class='rows' >
</div>


<div id='div_edit' class='edit' >
</div>


<div id='div_menu' class='menu' >

  <button id='btn_design' class='list' onclick="doDesign()">goto design</button>
  <button id='btn_parms' class='list' onclick="doRelations()">goto relations</button>

</div>  

</body>
</html>
